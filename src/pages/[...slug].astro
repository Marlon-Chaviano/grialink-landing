---
import { defaultLang, supportedLanguages } from "@/i18n/config";

/**
 * Catch-all redirect: bare paths like /terms, /about, /pricing → /{lang}/terms etc.
 * Detects browser language at runtime and redirects to the correct locale.
 */

const knownPages = ["about", "contact", "pricing", "privacy", "products", "terms"];

export function getStaticPaths() {
	const pages = ["about", "contact", "pricing", "privacy", "products", "terms"];
	return pages.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const langs = JSON.stringify(supportedLanguages);
const fallback = defaultLang;
---

<!doctype html>
<html
	lang={fallback}
	class="dark"
>
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<title>Redirecting… — Grialink</title>

		<!-- Fallback meta-refresh in case JS is disabled -->
		<meta
			http-equiv="refresh"
			content={`0;url=/${fallback}/${slug}`}
		/>

		<style>
			*,
			*::before,
			*::after {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				background: #0f1923;
				color: #f1f5f9;
				font-family: "Inter", system-ui, sans-serif;
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 100dvh;
				overflow: hidden;
			}
			.loader-wrapper {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 1.5rem;
				animation: fadeIn 0.3s ease-out;
			}
			.spinner {
				width: 44px;
				height: 44px;
				border: 3px solid rgba(253, 113, 0, 0.15);
				border-top-color: #fd7100;
				border-radius: 50%;
				animation: spin 0.8s linear infinite;
			}
			.loader-text {
				font-size: 0.875rem;
				color: #94a3b8;
				letter-spacing: 0.025em;
			}
			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}
			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(6px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}
			@media (prefers-reduced-motion: reduce) {
				.spinner {
					animation-duration: 1.6s;
				}
				.loader-wrapper {
					animation: none;
				}
			}
		</style>
	</head>

	<body>
		<div
			class="loader-wrapper"
			role="status"
			aria-live="polite"
		>
			<div
				class="spinner"
				aria-hidden="true"
			>
			</div>
			<p class="loader-text">Redirecting…</p>
		</div>

		<script is:inline define:vars={{ langs, fallback, slug }}>
			(function () {
				var supported = JSON.parse(langs);
				var navLang = (navigator.language || navigator.userLanguage || "").split("-")[0].toLowerCase();
				var target = supported.indexOf(navLang) !== -1 ? navLang : fallback;
				window.location.replace("/" + target + "/" + slug);
			})();
		</script>
	</body>
</html>
