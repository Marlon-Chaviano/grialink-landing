---
import "@/styles/global.css";
import type { Lang } from "@/i18n/config";
import Navbar from "@/components/layout/Navbar.astro";
import Footer from "@/components/layout/Footer.astro";

interface Props {
	lang: Lang;
	class?: string;
	/** Hide navbar (e.g. 404, minimal pages) */
	noNav?: boolean;
	/** Hide footer */
	noFooter?: boolean;
}

const { lang, class: className, noNav = false, noFooter = false } = Astro.props;
---

<!doctype html>
<html
	lang={lang}
	class="dark"
>
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<meta
			name="generator"
			content={Astro.generator}
		/>

		<!-- Fonts — preconnect + swap for perf -->
		<link
			rel="preconnect"
			href="https://fonts.googleapis.com"
		/>
		<link
			rel="preconnect"
			href="https://fonts.gstatic.com"
			crossorigin
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..800&display=swap"
			rel="stylesheet"
		/>

		<slot name="head" />

		<!-- Theme initialisation (avoid FOUC) -->
		<script is:inline>
			(function () {
				var s = localStorage.getItem("theme");
				var d = s === "dark" || (!s && matchMedia("(prefers-color-scheme:dark)").matches);
				document.documentElement.classList.toggle("light", !d);
				document.documentElement.classList.toggle("dark", d);
			})();
		</script>
	</head>
	<body class:list={["bg-background text-foreground antialiased", className]}>
		<!-- Skip to content — keyboard a11y -->
		<a
			href="#main-content"
			class="skip-to-content"
		>
			{lang === "es" ? "Ir al contenido principal" : "Skip to main content"}
		</a>

		{!noNav && <Navbar lang={lang} />}

		<div id="main-content">
			<slot />
		</div>

		{!noFooter && <Footer lang={lang} />}

		<script>
			// Scroll-triggered reveal animations (respects reduced motion)
			const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

			if (prefersReducedMotion) {
				// Show everything immediately
				document.querySelectorAll("[data-animate]").forEach((el) => {
					el.classList.add("is-visible");
				});
			} else {
				const observer = new IntersectionObserver(
					(entries) => {
						entries.forEach((entry) => {
							if (entry.isIntersecting) {
								entry.target.classList.add("is-visible");
								observer.unobserve(entry.target);
							}
						});
					},
					{ threshold: 0.08, rootMargin: "0px 0px -40px 0px" },
				);

				document.querySelectorAll("[data-animate]").forEach((el) => {
					observer.observe(el);
				});
			}
		</script>

		<!-- Chatwoot live chat -->
		<script is:inline>
			(function (d, t) {
				var BASE_URL = "https://app.grialink.com";
				var g = d.createElement(t),
					s = d.getElementsByTagName(t)[0];
				g.src = BASE_URL + "/packs/js/sdk.js";
				g.async = true;
				s.parentNode.insertBefore(g, s);
				g.onload = function () {
					window.chatwootSDK.run({
						websiteToken: "NLwCp3aUkuV5jVCUcv7Xzmdv",
						baseUrl: BASE_URL,
					});
				};
			})(document, "script");
		</script>
	</body>
</html>
